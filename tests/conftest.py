import pytest
from fastapi.testclient import TestClient
from unittest.mock import MagicMock, patch
import os

os.environ["GCP_PROJECT_ID"] = "test-project"
os.environ["AUTH_ENABLED"] = "false"
os.environ["RATE_LIMIT_ENABLED"] = "false"
os.environ["JWT_SECRET_KEY"] = "test-secret-key"

from app.main import app
from app.config import get_settings


@pytest.fixture
def client():
    """Test client for API"""
    return TestClient(app)


@pytest.fixture
def auth_client():
    """Test client with auth enabled"""
    os.environ["AUTH_ENABLED"] = "true"
    get_settings.cache_clear()

    client = TestClient(app)
    yield client

    os.environ["AUTH_ENABLED"] = "false"
    get_settings.cache_clear()


@pytest.fixture
def mock_vision_client():
    """Mock Google Cloud Vision client"""
    with patch("app.services.ocr_service.vision.ImageAnnotatorClient") as mock:
        mock_client = MagicMock()
        mock.return_value = mock_client
        yield mock_client


@pytest.fixture
def sample_image_bytes():
    """Minimal valid JPEG bytes for testing"""
    return bytes(
        [
            0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01,
            0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
            0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08, 0x07, 0x07, 0x07, 0x09,
            0x09, 0x08, 0x0A, 0x0C, 0x14, 0x0D, 0x0C, 0x0B, 0x0B, 0x0C, 0x19, 0x12,
            0x13, 0x0F, 0x14, 0x1D, 0x1A, 0x1F, 0x1E, 0x1D, 0x1A, 0x1C, 0x1C, 0x20,
            0x24, 0x2E, 0x27, 0x20, 0x22, 0x2C, 0x23, 0x1C, 0x1C, 0x28, 0x37, 0x29,
            0x2C, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1F, 0x27, 0x39, 0x3D, 0x38, 0x32,
            0x3C, 0x2E, 0x33, 0x34, 0x32, 0xFF, 0xC0, 0x00, 0x0B, 0x08, 0x00, 0x01,
            0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xFF, 0xC4, 0x00, 0x1F, 0x00, 0x00,
            0x01, 0x05, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
            0x09, 0x0A, 0x0B, 0xFF, 0xDA, 0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3F,
            0x00, 0xFB, 0xD5, 0xDB, 0x20, 0xA8, 0xF1, 0x45, 0x00, 0xFF, 0xD9,
        ]
    )


@pytest.fixture
def mock_vision_response_with_text():
    """Mock Vision API response with text"""
    response = MagicMock()
    response.error.message = ""
    response.full_text_annotation.text = "Hello World\nThis is test text"

    page = MagicMock()
    page.confidence = 0.95
    page.property.detected_languages = [MagicMock(language_code="en")]
    response.full_text_annotation.pages = [page]

    return response


@pytest.fixture
def mock_vision_response_no_text():
    """Mock Vision API response with no text"""
    response = MagicMock()
    response.error.message = ""
    response.full_text_annotation.text = ""
    response.full_text_annotation.pages = []
    return response
